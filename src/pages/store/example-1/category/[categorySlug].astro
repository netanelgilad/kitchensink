---
import BaseLayout from "../../../../layouts/BaseLayout.astro";
import StoreCollectionPage from "../../../../react-pages/store/example-1/index";
import { loadCollectionServiceConfig } from "../../../../headless/store/services/collection-service";
import { loadCurrentCartServiceConfig } from "../../../../headless/store/services/current-cart-service";
import { loadCategoriesConfig } from "../../../../headless/store/services/category-service";

// Get category slug from URL params
const { categorySlug } = Astro.params;

// Special case: if categorySlug is "all-products", this request should be handled 
// by the dedicated all-products.astro page, so we should not reach here in normal flow.
// However, if we do reach here, we redirect to ensure consistency
if (categorySlug === "all-products") {
  const queryString = Astro.url.search;
  const redirectUrl = queryString 
    ? `/store/example-1/category/all-products${queryString}`
    : '/store/example-1/category/all-products';
  return Astro.redirect(redirectUrl);
}

// Load categories to find the matching category ID
const categoriesConfig = await loadCategoriesConfig();
const selectedCategory = categoriesConfig.categories.find(
  (cat: any) => cat.slug === categorySlug
);

// Load initial data for services with selected category
const filteredCollectionServiceConfig = await loadCollectionServiceConfig(
  selectedCategory?._id || undefined,
  Astro.url.searchParams
);
const currentCartServiceConfig = await loadCurrentCartServiceConfig();

// If category not found, return 404
if (!selectedCategory) {
  return Astro.redirect('/404');
}
---

<BaseLayout>
  <title>Store Example 1 - {selectedCategory.name}</title>
  <meta
    name="description"
    content={`Browse our ${selectedCategory.name} products with traditional grid layout`}
  />

  <StoreCollectionPage
    client:load
    filteredCollectionServiceConfig={filteredCollectionServiceConfig}
    currentCartServiceConfig={currentCartServiceConfig}
    categoriesConfig={{...categoriesConfig, initialCategoryId: selectedCategory._id}}
    slot="body"
  />
</BaseLayout>